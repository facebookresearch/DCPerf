name: DCPerf Mediawiki CI
on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build_artifact:
    runs-on: ${{ matrix.host-machine.instance }}
    container:
      image: ${{ matrix.host-machine.container }}
      options: --user root --privileged --pid=host
      volumes:
          - /var/run/docker.sock:/var/run/docker.sock
    defaults:
      run:
        shell: bash
    env:
      PRELUDE: .github/scripts/setup_env.bash
      BUILD_ENV: build_env
    continue-on-error: false
    strategy:
      fail-fast: false
      matrix:
        host-machine: [
          { arch: x86, instance: "ubuntu-latest", container: "ubuntu:22.04", type: "ubuntu" },
          { arch: aarch64, instance: "ubuntu-24.04-arm", container: "ubuntu:22.04", type: "ubuntu" },
          { arch: x86, instance: "ubuntu-latest", container: "quay.io/centos/centos:stream9", type: "centos" }
        ]
        python-version: [ "3.12" ]
    steps:
    - name: Setup Build Container (ubuntu-based)
      if: ${{ matrix.host-machine.type == 'ubuntu' }}
      run: apt update -y; apt install -y build-essential git pciutils socat sudo wget dmidecode curl

    - name: Setup Build Container (centos-based)
      if: ${{ matrix.host-machine.type == 'centos' }}
      run: dnf update -y; dnf install -y git pciutils which dmidecode

    - name: Checkout the Repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Free Disk Space on Host
      run: . $PRELUDE; free_disk_space_on_host

    - name: Display System Info
      run: . $PRELUDE; print_system_info

    - name: Install Build Tools
      run: . $PRELUDE; install_build_tools

    - name: Setup Miniconda
      run: . $PRELUDE; setup_miniconda $HOME/miniconda

    - name: Create Conda Environment
      run: . $PRELUDE; create_conda_environment $BUILD_ENV ${{ matrix.python-version }}

    - name: Install Python Tools
      run: . $PRELUDE; install_python_tools $BUILD_ENV

    - name: Install HHVM
      run: . $PRELUDE; install_hhvm $BUILD_ENV

    - name: Install Mediawiki
      run: . $PRELUDE; install_mediawiki $BUILD_ENV

  build-centos-arm-selfhosted:
    name: CentOS 9 Self-Hosted Runner Test
    runs-on: [centos9-arm, self-hosted, Linux, ARM64]
    steps:
      - name: Print Hello
        run: echo "Hello from CentOS 9 self-hosted runner!"
      - name: Print OS Info
        run: cat /etc/os-release
      - name: Print Hostname
        run: hostname
